/* index.js */

let map;
let mensajeDiv, infoDiv, infoSismoContainer, infoEvento, listaSismos;

// Verifica localStorage
storageAvailable("localStorage");

// Evita iframe cross-origin
function isCrossOriginFrame() {
  try { 
    window.top.location.hostname; 
    return false; 
  } catch { 
    return true; 
  }
}
if (isCrossOriginFrame()) {
  window.location = "https://cires.org.mx/mapa";
}

// Audio
const eventoSnd  = new Audio("audio/VikingsHorn2.wav");
const sismoSnd   = new Audio("audio/PingSismo.wav");
const mensajeSnd = new Audio("audio/ecobeep.wav");

// Inicializa el mapa de Google (solo eventos y centrales)
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center:      { lat: 19.3, lng: -99.2 },
    zoom:        7,
    mapTypeId:   localStorage.getItem("tipoMapa") || google.maps.MapTypeId.TERRAIN
  });

  // Vista de lista de sismos
  listaSismos = new ListaSismosView("lista_sismos");

  // Contenedores y paneles
  mensajeDiv        = document.getElementById("mensaje-div");
  infoDiv           = document.getElementById("info-div");
  infoEvento        = new InfoEvento({ container: infoDiv, map });
  infoSismoContainer = document.getElementById("infoSismoContainer");

  // Controles en el mapa
  map.controls[google.maps.ControlPosition.TOP_CENTER]
     .push(mensajeDiv);
  map.controls[google.maps.ControlPosition.TOP_RIGHT]
     .push(document.getElementById("logo"));
  map.controls[google.maps.ControlPosition.RIGHT_TOP]
     .push(infoDiv);
  map.controls[google.maps.ControlPosition.LEFT_TOP]
     .push(document.getElementById("leyenda"));
  map.controls[google.maps.ControlPosition.LEFT_BOTTOM]
     .push(document.getElementById("info-disclaimer"));
  map.controls[google.maps.ControlPosition.BOTTOM_CENTER]
     .push(document.getElementById("panel"));

  // Estado inicial desconectado
  $("#conectadoLabelId").text("Desconectado").css("color", "red");
  $("#conectadoId").css({ fill: "#cc0000", stroke: "#660000" });
}

// WebSocket setup
const procesarService = new sasmexlib.ProcessServicePublic({});
new sasmexlib.PaqueteCires({ decod: e => procesarService.procesar(e) });

// WS Handlers
procesarService.on("lista-eventos", e => listaSismos.update(e));
procesarService.on("ultimo-evento", e => showEvento(e));
procesarService.on("ping", () => {
  clearTimeout(ConectadorPing);
  $("#conectadoId").css({ fill: "#00cc00", stroke: "#006600" });
  $("#conectadoLabelId").text("Conectado").css("color", "green");
  ConectadorPing = pingTimer();
});

function pingTimer() {
  return setTimeout(() => {
    $("#conectadoId").css({ fill: "#cc0000", stroke: "#660000" });
    $("#conectadoLabelId").text("Desconectado").css("color", "red");
  }, 60000);
}
let ConectadorPing = pingTimer();

// Lista de Sismos View
function ListaSismosView(containerId) {
  this.container = document.getElementById(containerId);
  this.container.innerHTML = "<h5>Bitácora de Eventos</h5><div id='tabla-container'></div>";
  this.tableContainer = this.container.querySelector('#tabla-container');
}

ListaSismosView.prototype.update = function(lista) {
  this.tableContainer.innerHTML = '';
  const tbl = document.createElement('table');
  tbl.className = 'table table-hover table-sm';

  const thead = tbl.createTHead().insertRow();
  ['ID','Nombre','Intensidad','Ssn','Fecha','Localidad','Centrales'].forEach(h => {
    const th = thead.insertCell();
    th.innerText = h;
    th.style.textAlign = 'center';
  });

  const tbody = document.createElement('tbody');
  lista.forEach(e => {
    const row = tbody.insertRow();
    row.insertCell().innerText = e.numero;
    row.insertCell().innerText = e.nombre;
    row.insertCell().innerText = e.color==1 ? 'Ligero' : e.color==2 ? 'Moderado' : 'Fuerte';
    row.insertCell().innerText = e.ssn ? '✔' : '';
    row.insertCell().innerText = e.fecha;
    row.insertCell().innerText = e.localidad;
    const cCell = row.insertCell();
    e.centrales.forEach(c => {
      const div = document.createElement('div');
      div.innerText = `${c.nombre} (${c.anticipacion}s)`;
      cCell.appendChild(div);
    });
  });
  tbl.appendChild(tbody);
  this.tableContainer.appendChild(tbl);
};

// InfoEvento for circles
function InfoEvento(opts) {
  this.map       = opts.map;
  this.container = opts.container;
}

InfoEvento.prototype.show = function(ev) {
  this.container.innerHTML = `<h3>¡Sismo: ${ev.mensaje}!</h3>`;
  this.drawCircles(ev.lat, ev.lng);
};

InfoEvento.prototype.drawCircles = function(lat, lng) {
  const center = new google.maps.LatLng(lat, lng);
  [200000,150000,100000,50000].forEach(r => {
    new google.maps.Circle({
      map: this.map,
      center,
      radius: r,
      strokeOpacity: 0.5,
      strokeWeight: 2
    });
  });
};

function showEvento(ev) {
  mensajeSnd.play();
  infoEvento.show(ev);
}

// Google Maps callback in HTML:
// <script async defer
//   src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap&libraries=geometry">
// </script>
